/*! sb-image-editor 0.2.2 | Copyright (c) 2016 sparrow.jang | MIT license */
!function(a){"use strict";function b(b,c){function e(e,f){function g(a){var b,c,d=e.dragEvent,g=e.resizeStartEvent,h=e.selected,i=f[0].clientHeight-h.height,j=f[0].clientWidth-h.width;d?(b=h.top-(d.clientY-a.clientY),c=h.left-(d.clientX-a.clientX),0>b?h.top=0:b>i?h.top=i:h.top=b,0>c?h.left=0:c>j?h.left=j:h.left=c,p.refreshAndRender(q,e.selected,r),e.dragEvent=a):g&&this.onResizeSelected(a)}function h(b){function c(){if(a.isDefined(e.aspectRatio)&&""!==e.aspectRatio){var b=0>k?-1*k:k,c=0>j?-1*j:j;b>c?k=0>k&&j>-1||k>-1&&0>j?-1*j:j:j=0>k&&j>-1||k>-1&&0>j?-1*k:k}}var d,f,g,h,i=e.resizeStartEvent,j=i.clientY-b.clientY,k=i.clientX-b.clientX,l=e.resizeDirection,m=e.selected;switch(l){case"nw":c(),d=m.top-j,f=m.left-k,h=m.width+k,g=m.height+j;break;case"ne":c(),d=m.top-j,f=m.left,h=m.width-k,g=m.height+j;break;case"sw":c(),d=m.top,f=m.left-k,g=m.height-j,h=m.width+k;break;case"se":c(),d=m.top,f=m.left,h=m.width-k,g=m.height-j;break;case"tr":d=m.top-j,g=m.height+j,f=m.left,h=m.width;break;case"br":d=m.top,g=m.height-j,f=m.left,h=m.width;break;case"lc":d=m.top,g=m.height,f=m.left-k,h=m.width+k;break;case"rc":d=m.top,g=m.height,f=m.left,h=m.width-k}g=0>d?g+d:g,h=0>f?h+f:h,this.resizeSelected(d,f,h,g),e.resizeStartEvent=b}function i(b,c,d,g){function h(){var a=m/o;a>k?(j.height=k,j.width=k*o):(j.height=a,j.width=m),j.left=c>0?c<j.left+j.width?c:j.left:0}function i(){var a=n*o;a>l?(j.width=l,j.height=l/o):(j.height=n,j.width=n*o),j.left=c>0?c<j.left+j.width?c:j.left:0}var j=e.selected,k=f[0].clientHeight-j.top,l=f[0].clientWidth-j.left,m=l>=d?0>d?0:d:l,n=k>=g?0>g?0:g:k;if(a.isDefined(e.aspectRatio)&&""!==e.aspectRatio){var o=parseInt(e.aspectRatio.split(":")[0])/parseInt(e.aspectRatio.split(":")[1]);if(isNaN(o))throw"Invalid aspect-ratio";j.width==m?i():j.height==n?h():g-n>d-m?i():h()}else j.top=b>0?b<j.top+j.height?b:j.top:0,j.left=c>0?c<j.left+j.width?c:j.left:0,j.width=l>=d?0>d?0:d:l,j.height=k>=g?0>g?0:g:k}function j(){e.dragEvent=null,e.resizeStartEvent=null}function k(c){var d=new Image,e=document.createElement("div"),f=b.defer(),g=a.element(document.body);return d.crossOrigin="Anonymous",e.style.cssText="width:0px;height:0px;overflow:hidden;",d.onload=function(){var a=d.width,b=d.height;e.parentNode.removeChild(e),f.resolve({width:a,height:b})},e.appendChild(d),d.src=a.isString(c)?c:c.src,g.append(e),f.promise}function l(a){var b=a?a:"image/png";return p.toDataURL(b,e.selected)}function m(){p.refreshAndRender(q,e.selected,r)}var n,o,p,q,r,s,t;f.css({position:"relative","user-drag":"none"}).attr("unselectable","on"),o=f.find("canvas"),n=o[0],p=new d(n),q=f.find("img")[0],s=a.element(document.body),t={imgSrc:function(a){k(a).then(function(a){r=a,p.refreshAndRender(q,e.selected,r),e.onImgChange({imgSize:r})})},selected:function(a){null==e.dragEvent&&r&&p.refreshAndRender(q,a,r)},aspectRatio:function(){var a=e.selected;e.resizeSelected(a.top,a.left,a.width,a.height)}},e.$watch("imgSrc",t.imgSrc),e.$watch("aspectRatio",t.aspectRatio),e.$watchCollection("selected",t.selected),a.extend(e,{move:g,onResizeSelected:h,resizeSelected:i,cancel:j,sbImageEditor:{toDataURL:l,refresh:m}}),c.on("mousemove",function(a){e.move(a),e.$apply()}),c.on("mouseup",function(){e.cancel()})}return{scope:{imgSrc:"=",sbImageEditor:"=",onImgChange:"&",enabledResizeSelector:"=",selected:"=",aspectRatio:"@"},template:'<div ng-mouseup="cancel( $event )" unselectable="on"><img unselectable="on" style="opacity:0;user-drag: none;width:100%;height:100%;" crossorigin="Anonymous" ng-src="{{imgSrc}}" ng-mousedown="$event.preventDefault()" /><canvas width="100%" height="100%" style="position:absolute;top:0px;left:0px;"></canvas><div sb-image-selected></div></div>',controller:e}}var c=a.module("sbImageEditor",[]),d=function(a){this.canvas_=a,this.ctx_=a.getContext("2d")};d.prototype.refresh=function(){var a=this.canvas_,b=a.parentNode;a.width=b.clientWidth,a.height=b.clientHeight},d.prototype.converterToGray_=function(){var a,b,c,d=this.ctx_,e=this.canvas_;if(0!==e.width&&0!==e.height){a=d.getImageData(0,0,e.width,e.height),b=a.data,c=b.length;for(var f=0;c>f;f+=4){var g=b[f],h=b[f+1],i=b[f+2],j=.34*g+.5*h+.16*i;b[f]=j,b[f+1]=j,b[f+2]=j}d.putImageData(a,0,0)}},d.prototype.drawImageBlock=function(a,b,c,d,e,f,g,h,i){var j=h/a.width,k=i/a.height,l=d/a.width*f,m=e/a.height*g,n=f*j,o=g*k;b.drawImage(c,l,m,n,o,d,e,h,i)},d.prototype.render=function(a,b,c){if(c){var d=this.ctx_,e=this.canvas_,f=e.width,g=e.height;d.drawImage(a,0,0,f,g),this.converterToGray_(),this.drawImageBlock(e,d,a,b.left,b.top,c.width,c.height,b.width,b.height)}},d.prototype.refreshAndRender=function(a,b,c){this.refresh(),this.render(a,b,c)},d.prototype.toDataURL=function(a,b){var c=this.canvas_,d=document.createElement("canvas"),e=d.getContext("2d");return d.width=b.width,d.height=b.height,e.drawImage(c,b.left,b.top,b.width,b.height,0,0,b.width,b.height),d.toDataURL(a)},c.directive("sbImageEditor",b),b.$inject=["$q","$document"],"undefined"!=typeof module&&(module.exports="ngImageEditor")}(angular);
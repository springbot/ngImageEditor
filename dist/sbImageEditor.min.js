/*! sb-image-editor 0.2.4 | Copyright (c) 2016 sparrow.jang | MIT license */
!function(a){"use strict";function b(b,c){function d(d,f){function g(a){var b,c,e=d.dragEvent,g=d.resizeStartEvent,h=d.selected,i=f[0].clientHeight-h.height,j=f[0].clientWidth-h.width;e?(b=h.top-(e.clientY-a.clientY),c=h.left-(e.clientX-a.clientX),0>b?h.top=0:b>i?h.top=i:h.top=b,0>c?h.left=0:c>j?h.left=j:h.left=c,p.refreshAndRender(q,d.selected,r),d.dragEvent=a):g&&this.onResizeSelected(a)}function h(b){function c(){if(a.isDefined(d.aspectRatio)&&""!==d.aspectRatio){var b=0>k?-1*k:k,c=0>j?-1*j:j;b>c?k=0>k&&j>-1||k>-1&&0>j?-1*j:j:j=0>k&&j>-1||k>-1&&0>j?-1*k:k}}var e,f,g,h,i=d.resizeStartEvent,j=i.clientY-b.clientY,k=i.clientX-b.clientX,l=d.selected;switch(d.resizeDirection){case"nw":c(),e=l.top-j,f=l.left-k,h=l.width+k,g=l.height+j;break;case"ne":c(),e=l.top-j,f=l.left,h=l.width-k,g=l.height+j;break;case"sw":c(),e=l.top,f=l.left-k,g=l.height-j,h=l.width+k;break;case"se":c(),e=l.top,f=l.left,h=l.width-k,g=l.height-j;break;case"tr":e=l.top-j,g=l.height+j,f=l.left,h=l.width;break;case"br":e=l.top,g=l.height-j,f=l.left,h=l.width;break;case"lc":e=l.top,g=l.height,f=l.left-k,h=l.width+k;break;case"rc":e=l.top,g=l.height,f=l.left,h=l.width-k}g=0>e?g+e:g,h=0>f?h+f:h,this.resizeSelected(e,f,h,g),d.resizeStartEvent=b}function i(b,c,e,g){function h(){var a=m/o;a>k?(j.height=k,j.width=k*o):(j.height=a,j.width=m),j.left=c>0?c<j.left+j.width?c:j.left:0}function i(){var a=n*o;a>l?(j.width=l,j.height=l/o):(j.height=n,j.width=n*o),j.left=c>0?c<j.left+j.width?c:j.left:0}var j=d.selected,k=f[0].clientHeight-j.top,l=f[0].clientWidth-j.left,m=l>=e?0>e?0:e:l,n=k>=g?0>g?0:g:k;if(a.isDefined(d.aspectRatio)&&""!==d.aspectRatio){var o=parseInt(d.aspectRatio.split(":")[0])/parseInt(d.aspectRatio.split(":")[1]);if(isNaN(o))throw"Invalid aspect-ratio";j.width==m?i():j.height==n?h():g-n>e-m?i():h()}else j.top=b>0?b<j.top+j.height?b:j.top:0,j.left=c>0?c<j.left+j.width?c:j.left:0,j.width=l>=e?0>e?0:e:l,j.height=k>=g?0>g?0:g:k}function j(){d.dragEvent=null,d.resizeStartEvent=null}function k(c){var d=new Image,e=document.createElement("div"),f=b.defer(),g=a.element(document.body);return d.crossOrigin="Anonymous",e.style.cssText="width:0px;height:0px;overflow:hidden;",d.onload=function(){var a=d.width,b=d.height;e.parentNode.removeChild(e),f.resolve({width:a,height:b})},e.appendChild(d),d.src=a.isString(c)?c:c.src,g.append(e),f.promise}function l(a){var b=a?a:"image/png";return p.toDataURL(b,d.selected)}function m(){p.refreshAndRender(q,d.selected,r)}var n,o,p,q,r,s;f.css({position:"relative","user-drag":"none"}).attr("unselectable","on"),o=f.find("canvas"),n=o[0],p=new e(n),q=f.find("img")[0],s=a.element(document.body),d.move=g,d.onResizeSelected=h,d.resizeSelected=i,d.cancel=j,d.sbImageEditor={toDataURL:l,refresh:m},d.$watch("imgSrc",function(a){k(a).then(function(a){r=a,p.refreshAndRender(q,d.selected,r),d.onImgChange()(r)})}),d.$watch("aspectRatio",function(){var a=d.selected;d.resizeSelected(a.top,a.left,a.width,a.height)}),d.$watchCollection("selected",function(a){function b(){var b=p.canvas_.width,c=p.canvas_.height,d=a.width,e=a.height,f=r.width,g=r.height;a.width=d/f*b,a.height=e/g*c,a.rawInput=!1}null==d.dragEvent&&r&&(a.rawInput&&b(),p.refreshAndRender(q,a,r))}),c.on("mousemove",function(a){d.move(a),d.$apply()}),c.on("mouseup",function(){d.cancel()})}return{scope:{imgSrc:"=",sbImageEditor:"=",onImgChange:"&",enabledResizeSelector:"=",selected:"=",aspectRatio:"@"},template:'<div ng-mouseup="cancel( $event )" unselectable="on"><img unselectable="on" style="opacity:0;user-drag: none;width:100%;height:100%;" crossorigin="Anonymous" ng-src="{{imgSrc}}" ng-mousedown="$event.preventDefault()" /><canvas width="100%" height="100%" style="position:absolute;top:0px;left:0px;"></canvas><div sb-image-selected></div></div>',controller:d}}function c(){function a(a){function b(a,b){a.preventDefault(),a.stopPropagation(),this.resizeStartEvent=a,this.resizeDirection=b}a.onResizeBlock=b}return{require:"^sbImageEditor",selected:"=",template:"<div style=\"box-sizing:border-box;background:rgba(255, 255, 255, 0.1);border:2px dashed #eaeaea;cursor:all-scroll;position:absolute;\" ng-style=\"{width:selected.width + 'px' , height:selected.height + 'px',left:selected.left + 'px',top:selected.top + 'px'}\" ng-mousedown=\"dragEvent=$event;$event.preventDefault()\"><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'nw' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);top: -4px;left: -4px;position: absolute; cursor: nw-resize;\"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'ne' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);top: -4px;right: -4px;position: absolute; cursor: ne-resize;\"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'sw' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);bottom: -4px;left: -4px;position: absolute; cursor: sw-resize;\"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'se' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);bottom: -4px;right: -4px;position: absolute; cursor: se-resize; \"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'tr' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);top: -4px;right: 49%;position: absolute; cursor: row-resize; \"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'br' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);bottom: -4px;right: 49%;position: absolute; cursor: row-resize; \"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'lc' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);bottom: 49%;left: -4px;position: absolute; cursor: col-resize;; \"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'rc' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);bottom: 49%;right: -4px;position: absolute; cursor: col-resize;; \"></div></div>",replace:!0,link:a}}var d=a.module("sbImageEditor",[]),e=function(a){this.canvas_=a,this.ctx_=a.getContext("2d")};e.prototype.refresh=function(){var a=this.canvas_,b=a.parentNode;a.width=b.clientWidth,a.height=b.clientHeight},e.prototype.converterToGray_=function(){var a,b,c,d=this.ctx_,e=this.canvas_;if(0!==e.width&&0!==e.height){a=d.getImageData(0,0,e.width,e.height),b=a.data,c=b.length;for(var f=0;c>f;f+=4){var g=b[f],h=b[f+1],i=b[f+2],j=.34*g+.5*h+.16*i;b[f]=j,b[f+1]=j,b[f+2]=j}d.putImageData(a,0,0)}},e.prototype.drawImageBlock=function(a,b,c,d,e,f,g,h,i){var j=h/a.width,k=i/a.height,l=d/a.width*f,m=e/a.height*g,n=f*j,o=g*k;b.drawImage(c,l,m,n,o,d,e,h,i)},e.prototype.render=function(a,b,c){if(c){var d=this.ctx_,e=this.canvas_,f=e.width,g=e.height;d.drawImage(a,0,0,f,g),this.converterToGray_(),this.drawImageBlock(e,d,a,b.left,b.top,c.width,c.height,b.width,b.height)}},e.prototype.refreshAndRender=function(a,b,c){this.refresh(),this.render(a,b,c)},e.prototype.toDataURL=function(a,b){var c=this.canvas_,d=document.createElement("canvas"),e=d.getContext("2d");return d.width=b.width,d.height=b.height,e.drawImage(c,b.left,b.top,b.width,b.height,0,0,b.width,b.height),d.toDataURL(a)},d.directive("sbImageEditor",b),b.$inject=["$q","$document"],d.directive("sbImageSelected",c),c.$inject=[],"undefined"!=typeof module&&(module.exports="ngImageEditor")}(angular);
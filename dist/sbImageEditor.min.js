/*! sb-image-editor 0.2.5 | Copyright (c) 2016 sparrow.jang | MIT license */
!function(){"use strict";function a(a,b){function c(c,e){function f(a){var b,d,f=c.dragEvent,g=c.resizeStartEvent,h=c.selected,i=e[0].clientHeight-h.height,j=e[0].clientWidth-h.width;f?(b=h.top-(f.clientY-a.clientY),d=h.left-(f.clientX-a.clientX),0>b?h.top=0:b>i?h.top=i:h.top=b,0>d?h.left=0:d>j?h.left=j:h.left=d,o.refreshAndRender(p,c.selected,q),c.dragEvent=a):g&&this.onResizeSelected(a)}function g(a){function b(){if(angular.isDefined(c.aspectRatio)&&""!==c.aspectRatio){var a=0>j?-1*j:j,b=0>i?-1*i:i;a>b?j=0>j&&i>-1||j>-1&&0>i?-1*i:i:i=0>j&&i>-1||j>-1&&0>i?-1*j:j}}var d,e,f,g,h=c.resizeStartEvent,i=h.clientY-a.clientY,j=h.clientX-a.clientX,k=c.selected;switch(c.resizeDirection){case"nw":b(),d=k.top-i,e=k.left-j,g=k.width+j,f=k.height+i;break;case"ne":b(),d=k.top-i,e=k.left,g=k.width-j,f=k.height+i;break;case"sw":b(),d=k.top,e=k.left-j,f=k.height-i,g=k.width+j;break;case"se":b(),d=k.top,e=k.left,g=k.width-j,f=k.height-i;break;case"tr":d=k.top-i,f=k.height+i,e=k.left,g=k.width;break;case"br":d=k.top,f=k.height-i,e=k.left,g=k.width;break;case"lc":d=k.top,f=k.height,e=k.left-j,g=k.width+j;break;case"rc":d=k.top,f=k.height,e=k.left,g=k.width-j}f=0>d?f+d:f,g=0>e?g+e:g,this.resizeSelected(d,e,g,f),c.resizeStartEvent=a}function h(a,b,d,f){function g(){var a=l/n;a>j?(i.height=j,i.width=j*n):(i.height=a,i.width=l),i.left=b>0?b<i.left+i.width?b:i.left:0}function h(){var a=m*n;a>k?(i.width=k,i.height=k/n):(i.height=m,i.width=m*n),i.left=b>0?b<i.left+i.width?b:i.left:0}var i=c.selected,j=e[0].clientHeight-i.top,k=e[0].clientWidth-i.left,l=k>=d?0>d?0:d:k,m=j>=f?0>f?0:f:j;if(angular.isDefined(c.aspectRatio)&&""!==c.aspectRatio){var n=parseInt(c.aspectRatio.split(":")[0])/parseInt(c.aspectRatio.split(":")[1]);if(isNaN(n))throw"Invalid aspect-ratio";i.width==l?h():i.height==m?g():f-m>d-l?h():g()}else i.top=a>0?a<i.top+i.height?a:i.top:0,i.left=b>0?b<i.left+i.width?b:i.left:0,i.width=k>=d?0>d?0:d:k,i.height=j>=f?0>f?0:f:j}function i(){c.dragEvent=null,c.resizeStartEvent=null}function j(b){var c=new Image,d=document.createElement("div"),e=a.defer(),f=angular.element(document.body);return c.crossOrigin="Anonymous",d.style.cssText="width:0px;height:0px;overflow:hidden;",c.onload=function(){var a=c.width,b=c.height;d.parentNode.removeChild(d),e.resolve({width:a,height:b})},d.appendChild(c),c.src=angular.isString(b)?b:b.src,f.append(d),e.promise}function k(a){var b=a?a:"image/png";return o.toDataURL(b,c.selected)}function l(){o.refreshAndRender(p,c.selected,q)}var m,n,o,p,q,r;e.css({position:"relative","user-drag":"none"}).attr("unselectable","on"),n=e.find("canvas"),m=n[0],o=new d(m),p=e.find("img")[0],r=angular.element(document.body),c.move=f,c.onResizeSelected=g,c.resizeSelected=h,c.cancel=i,c.sbImageEditor={toDataURL:k,refresh:l},c.$watch("imgSrc",function(a){j(a).then(function(a){q=a,o.refreshAndRender(p,c.selected,q),c.onImgChange()(q)})}),c.$watch("aspectRatio",function(){var a=c.selected;c.resizeSelected(a.top,a.left,a.width,a.height)}),c.$watchCollection("selected",function(a){if(null==c.dragEvent&&q){if(a.rawInput){var b=o.canvas_.width,d=o.canvas_.height,e=a.width,f=a.height,g=q.width,h=q.height;a.width=e/g*b,a.height=f/h*d,a.rawInput=!1}o.refreshAndRender(p,a,q)}}),b.on("mousemove",function(a){c.move(a),c.$apply()}),b.on("mouseup",function(){c.cancel()})}return{scope:{imgSrc:"=",sbImageEditor:"=",onImgChange:"&",enabledResizeSelector:"=",selected:"=",aspectRatio:"@"},template:'<div ng-mouseup="cancel( $event )" unselectable="on"><img unselectable="on" style="opacity:0;user-drag: none;width:100%;height:100%;" crossorigin="Anonymous" ng-src="{{imgSrc}}" ng-mousedown="$event.preventDefault()" /><canvas width="100%" height="100%" style="position:absolute;top:0px;left:0px;"></canvas><div sb-image-selected></div></div>',controller:c}}function b(){function a(a){function b(a,b){a.preventDefault(),a.stopPropagation(),this.resizeStartEvent=a,this.resizeDirection=b}a.onResizeBlock=b}return{require:"^sbImageEditor",selected:"=",template:"<div style=\"box-sizing:border-box;background:rgba(255, 255, 255, 0.1);border:2px dashed #eaeaea;cursor:all-scroll;position:absolute;\" ng-style=\"{width:selected.width + 'px' , height:selected.height + 'px',left:selected.left + 'px',top:selected.top + 'px'}\" ng-mousedown=\"dragEvent=$event;$event.preventDefault()\"><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'nw' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);top: -4px;left: -4px;position: absolute; cursor: nw-resize;\"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'ne' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);top: -4px;right: -4px;position: absolute; cursor: ne-resize;\"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'sw' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);bottom: -4px;left: -4px;position: absolute; cursor: sw-resize;\"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'se' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);bottom: -4px;right: -4px;position: absolute; cursor: se-resize; \"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'tr' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);top: -4px;right: 49%;position: absolute; cursor: row-resize; \"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'br' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);bottom: -4px;right: 49%;position: absolute; cursor: row-resize; \"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'lc' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);bottom: 49%;left: -4px;position: absolute; cursor: col-resize;; \"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'rc' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);bottom: 49%;right: -4px;position: absolute; cursor: col-resize;; \"></div></div>",replace:!0,link:a}}var c=angular.module("sbImageEditor",[]),d=function(a){this.canvas_=a,this.ctx_=a.getContext("2d")};d.prototype.refresh=function(){var a=this.canvas_,b=a.parentNode;a.width=b.clientWidth,a.height=b.clientHeight},d.prototype.converterToGray_=function(){var a,b,c,d=this.ctx_,e=this.canvas_;if(0!==e.width&&0!==e.height){a=d.getImageData(0,0,e.width,e.height),b=a.data,c=b.length;for(var f=0;c>f;f+=4){var g=b[f],h=b[f+1],i=b[f+2],j=.34*g+.5*h+.16*i;b[f]=j,b[f+1]=j,b[f+2]=j}d.putImageData(a,0,0)}},d.prototype.drawImageBlock=function(a,b,c,d,e,f,g,h,i){var j=h/a.width,k=i/a.height,l=d/a.width*f,m=e/a.height*g,n=f*j,o=g*k;b.drawImage(c,l,m,n,o,d,e,h,i)},d.prototype.render=function(a,b,c){if(c){var d=this.ctx_,e=this.canvas_,f=e.width,g=e.height;d.drawImage(a,0,0,f,g),this.converterToGray_(),this.drawImageBlock(e,d,a,b.left,b.top,c.width,c.height,b.width,b.height)}},d.prototype.refreshAndRender=function(a,b,c){this.refresh(),this.render(a,b,c)},d.prototype.toDataURL=function(a,b){var c=this.canvas_,d=document.createElement("canvas"),e=d.getContext("2d");return d.width=b.width,d.height=b.height,e.drawImage(c,b.left,b.top,b.width,b.height,0,0,b.width,b.height),d.toDataURL(a)},c.directive("sbImageEditor",a),a.$inject=["$q","$document"],c.directive("sbImageSelected",b),b.$inject=[]}();